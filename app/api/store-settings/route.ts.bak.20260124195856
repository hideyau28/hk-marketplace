export const runtime = "nodejs";

import { prisma } from "@/lib/prisma";
import { ApiError, ok, withApi } from "@/lib/api/route-helpers";

function requireAdminSecret(req: Request) {
  const secret = process.env.ADMIN_SECRET;
  if (!secret) {
    // fail-closed: server misconfig must NOT allow access
    throw new ApiError(500, "INTERNAL", "ADMIN_SECRET is not set");
  }
  const got = req.headers.get("x-admin-secret") ?? "";
  if (!got || got !== secret) {
    throw new ApiError(401, "UNAUTHORIZED", "Missing or invalid admin secret");
  }
}

// GET /api/store-settings
export const GET = withApi(async (req) => {
  requireAdminSecret(req);

  const row = await prisma.storeSettings.findFirst().catch(() => null);
  return ok(req, row ?? null);
}, { admin: true });

// PUT /api/store-settings
export const PUT = withApi(async (req) => {
  requireAdminSecret(req);

  let body: any = null;
  try {
    body = await req.json();
  } catch {
    throw new ApiError(400, "BAD_REQUEST", "Invalid JSON body");
  }

  const updated = await prisma.storeSettings.upsert({
    where: { id: body?.id ?? "default" },
    update: body ?? {},
    create: { id: body?.id ?? "default", ...(body ?? {}) },
  });

  return ok(req, updated);
}, { admin: true });
