generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model StoreSettings {
  id             String   @id @default("default")
  storeName      String?
  tagline        String?
  returnsPolicy  String?
  shippingPolicy String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  route        String
  method       String
  requestHash  String
  status       Int
  responseJson Json
  createdAt    DateTime @default(now())

  @@unique([key, route, method])
  @@index([createdAt])
}

model Order {
  id                      String           @id @default(cuid())
  customerName            String
  phone                   String
  email                   String?
  items                   Json
  amounts                 Json
  fulfillmentType         FulfillmentType
  fulfillmentAddress      Json?
  status                  OrderStatus      @default(PENDING)
  note                    String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  paidAt                  DateTime?
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  cancelledAt             DateTime?
  completedAt             DateTime?
  disputedAt              DateTime?
  fulfillingAt            DateTime?
  refundedAt              DateTime?
  shippedAt               DateTime?
  paymentAttempts         PaymentAttempt[]

  @@index([status])
  @@index([createdAt])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
}

model PaymentAttempt {
  id                      String               @id @default(cuid())
  provider                PaymentProvider
  status                  PaymentAttemptStatus @default(CREATED)
  orderId                 String
  amount                  Int?
  currency                String?
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  stripeChargeId          String?
  failureCode             String?
  failureMessage          String?
  lastEventId             String?
  lastEventType           String?
  lastEvent               Json?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  order                   Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([provider, status])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
}

model Product {
  id            String   @id @default(cuid())
  title         String
  price         Float
  imageUrl      String?
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  badges        Json?
  brand         String?
  category      String?
  sizeSystem    String?
  sizes         Json?
  stock         Int      @default(0)
  originalPrice Float?
  images        String[]
  color         String?
  shoeType      String?
  sku           String?  @unique

  @@index([active])
  @@index([brand])
  @@index([category])
}

model Coupon {
  id            String             @id @default(cuid())
  code          String             @unique
  discountType  CouponDiscountType
  discountValue Float
  minOrder      Float?
  active        Boolean            @default(true)
  expiresAt     DateTime?
  createdAt     DateTime           @default(now())

  @@index([active])
  @@index([code])
}

model AdminLog {
  id         String   @id @default(cuid())
  action     String
  resource   String?
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([action])
  @@index([resource])
}

model SiteContent {
  id           String   @id @default(cuid())
  key          String   @unique
  type         String
  titleEn      String
  titleZh      String
  subtitleEn   String?
  subtitleZh   String?
  buttonTextEn String?
  buttonTextZh String?
  buttonLink   String?
  imageUrl     String?
  active       Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([type, active])
  @@index([sortOrder])
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLING
  SHIPPED
  COMPLETED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum PaymentProvider {
  STRIPE
}

enum PaymentAttemptStatus {
  CREATED
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum CouponDiscountType {
  PERCENTAGE
  FIXED
}
