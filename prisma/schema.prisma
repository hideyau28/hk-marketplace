generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model StoreSettings {
  id                      String   @id @default("default")
  storeName               String?
  storeNameEn             String?  // English store name
  storeLogo               String?  // Logo URL
  tagline                 String?
  returnsPolicy           String?
  shippingPolicy          String?
  welcomePopupEnabled     Boolean  @default(true)
  welcomePopupTitle       String?
  welcomePopupSubtitle    String?
  welcomePopupPromoText   String?
  welcomePopupButtonText  String?
  // Contact info
  whatsappNumber          String?
  instagramUrl            String?
  facebookUrl             String?
  // Business hours
  openingHours            String?
  pickupHours             String?
  // Pickup address
  pickupAddress           String?
  pickupAddressZh         String?  // Pickup address in Chinese
  pickupAddressEn         String?  // Pickup address in English
  // Shipping
  shippingFee             Float    @default(40)
  freeShippingThreshold   Float    @default(600)
  // Home delivery settings
  homeDeliveryFee         Float?   @default(40)
  homeDeliveryFreeAbove   Float?   @default(600)
  homeDeliveryIslandExtra Float?   @default(20)
  // SF Locker/Station settings
  sfLockerFee             Float?   @default(35)
  sfLockerFreeAbove       Float?   @default(600)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  // Multi-tenant
  tenantId                String
  tenant                  Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  route        String
  method       String
  requestHash  String
  status       Int
  responseJson Json
  createdAt    DateTime @default(now())
  // Multi-tenant
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([key, route, method])
  @@index([createdAt])
  @@index([tenantId])
}

model User {
  id        String   @id @default(cuid())
  phone     String   @unique // HK phone: +852XXXXXXXX
  name      String?
  email     String?
  address   String?  // default shipping address (JSON)
  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Multi-tenant
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([phone])
  @@index([tenantId])
}

model Order {
  id                      String           @id @default(cuid())
  orderNumber             String?          @unique
  customerName            String
  phone                   String
  email                   String?
  items                   Json
  amounts                 Json
  fulfillmentType         FulfillmentType
  fulfillmentAddress      Json?
  status                  OrderStatus      @default(PENDING)
  note                    String?
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt
  paidAt                  DateTime?
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  cancelledAt             DateTime?
  completedAt             DateTime?
  disputedAt              DateTime?
  fulfillingAt            DateTime?
  refundedAt              DateTime?
  shippedAt               DateTime?
  paymentAttempts         PaymentAttempt[]
  // Local payment fields (FPS/PayMe/Alipay)
  paymentMethod           String?          // "fps", "payme", "alipay"
  paymentProof            String?          // uploaded image URL/path
  paymentStatus           String           @default("pending") // pending, uploaded, confirmed, rejected
  paymentConfirmedAt      DateTime?
  paymentConfirmedBy      String?          // admin who confirmed the payment
  // New status timestamps
  confirmedAt             DateTime?
  deliveredAt             DateTime?
  processingAt            DateTime?
  // Admin management fields
  adminNotes              String?          // JSON array of {timestamp, note, author}
  trackingNumber          String?
  cancelReason            String?
  refundReason            String?
  statusHistory           String?          // JSON array of {timestamp, fromStatus, toStatus}
  // Member system
  userId                  String?
  user                    User?            @relation(fields: [userId], references: [id])
  // Multi-tenant
  tenantId                String
  tenant                  Tenant           @relation(fields: [tenantId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
  @@index([phone])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([userId])
  @@index([tenantId])
}

model PaymentAttempt {
  id                      String               @id @default(cuid())
  provider                PaymentProvider
  status                  PaymentAttemptStatus @default(CREATED)
  orderId                 String
  amount                  Int?
  currency                String?
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  stripeChargeId          String?
  failureCode             String?
  failureMessage          String?
  lastEventId             String?
  lastEventType           String?
  lastEvent               Json?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  order                   Order                @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([provider, status])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
}

model Product {
  id              String   @id @default(cuid())
  title           String
  price           Float
  imageUrl        String?
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  badges          Json?
  brand           String?
  category        String?
  sizeSystem      String?
  sizes           Json?
  stock           Int      @default(0)
  originalPrice   Float?
  images          String[]
  color           String?
  shoeType        String?
  sku             String?  @unique
  featured        Boolean  @default(false)
  promotionBadges String[]         @default([])
  // Category relation
  categoryId      String?
  categoryRel     Category?        @relation(fields: [categoryId], references: [id])
  // Variant system (通用款式選擇器)
  variantLabel    String?    // 商戶自定義嘅 variant 顯示名，例如 "尺碼"/"圈碼"/"尺寸"/"型號"
  variants        Json?      // {"US 7": {"qty": 2, "status": "available"}, "US 8": {"qty": 0, "status": "restocking"}}
  promoEndDate    DateTime?  // 限時優惠結束時間
  // Variants & attributes
  productVariants ProductVariant[]
  attributes      Json?
  // Multi-tenant
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])

  @@index([active])
  @@index([brand])
  @@index([category])
  @@index([featured])
  @@index([categoryId])
  @@index([tenantId])
}

model Badge {
  id        String   @id @default(cuid())
  nameZh    String
  nameEn    String
  color     String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Multi-tenant
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
}

model Coupon {
  id            String             @id @default(cuid())
  code          String             @unique
  discountType  CouponDiscountType
  discountValue Float
  minOrder      Float?
  active        Boolean            @default(true)
  expiresAt     DateTime?
  createdAt     DateTime           @default(now())
  // Multi-tenant
  tenantId      String
  tenant        Tenant             @relation(fields: [tenantId], references: [id])

  @@index([active])
  @@index([code])
  @@index([tenantId])
}

model AdminLog {
  id         String   @id @default(cuid())
  action     String
  resource   String?
  resourceId String?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  // Multi-tenant
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])

  @@index([createdAt])
  @@index([action])
  @@index([resource])
  @@index([tenantId])
}

model SiteContent {
  id           String   @id @default(cuid())
  key          String   @unique
  type         String
  titleEn      String
  titleZh      String
  subtitleEn   String?
  subtitleZh   String?
  buttonTextEn String?
  buttonTextZh String?
  buttonLink   String?
  imageUrl     String?
  active       Boolean  @default(true)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  // Multi-tenant
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  @@index([type, active])
  @@index([sortOrder])
  @@index([tenantId])
}

model Tenant {
  id                   String    @id @default(cuid())
  name                 String
  slug                 String    @unique
  description          String?
  customDomain         String?   @unique
  region               String    @default("HK")
  currency             String    @default("HKD")
  timezone             String    @default("Asia/Hong_Kong")
  languages            String[]  @default(["zh-HK", "en"])
  taxRate              Float     @default(0)
  themeColor           String    @default("#6B7B3A")
  logoUrl              String?
  whatsapp             String?
  instagram            String?
  brandColor           String?   @default("#FF9500")
  template             String    @default("default")
  status               String    @default("active")
  stripeCustomerId     String?
  stripeSubscriptionId String?
  subscriptionEndsAt   DateTime?
  // Stripe Connect (tenant's own Stripe account for receiving payments)
  stripeAccountId      String?
  stripeOnboarded      Boolean   @default(false)
  // FPS 轉數快
  fpsEnabled           Boolean   @default(false)
  fpsAccountName       String?
  fpsAccountId         String?
  fpsQrCodeUrl         String?
  // PayMe
  paymeEnabled         Boolean   @default(false)
  paymeLink            String?
  paymeQrCodeUrl       String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  admins               TenantAdmin[]
  products             Product[]
  orders               Order[]
  users                User[]
  badges               Badge[]
  coupons              Coupon[]
  adminLogs            AdminLog[]
  siteContents         SiteContent[]
  storeSettings        StoreSettings[]
  homepageSections     HomepageSection[]
  homepageBanners      HomepageBanner[]
  paymentMethods       PaymentMethod[]
  idempotencyKeys      IdempotencyKey[]
  categories           Category[]
  productVariants      ProductVariant[]
  attributeDefinitions AttributeDefinition[]
  paymentConfigs       TenantPaymentConfig[]
}

model TenantAdmin {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  email        String   @unique
  name         String?
  passwordHash String
  role         String   @default("owner")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
}

enum OrderStatus {
  // New status flow
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
  // Legacy statuses (backward compatibility)
  PAID
  FULFILLING
  DISPUTED
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum PaymentProvider {
  STRIPE
}

enum PaymentAttemptStatus {
  CREATED
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum CouponDiscountType {
  PERCENTAGE
  FIXED
}

model HomepageSection {
  id          String   @id @default(cuid())
  title       String   // e.g. "為你推薦", "Air Jordan"
  type        String   // "product_grid", "banner"
  cardSize    String   @default("small") // "small" or "large"
  sortOrder   Int      @default(0)
  active      Boolean  @default(true)
  productIds  String[] // manually selected product IDs (for product_grid)
  filterType  String?  // alternative: auto-filter by shoeType/category
  filterValue String?  // e.g. "adult", "Air Jordan"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  // Multi-tenant
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([sortOrder])
  @@index([active])
  @@index([tenantId])
}

model HomepageBanner {
  id        String   @id @default(cuid())
  imageUrl  String   // banner image URL (fallback for single image)
  title     String?  // overlay text
  subtitle  String?  // overlay subtitle
  linkUrl   String?  // click destination (optional, no button)
  images    Json?    // array of slides: [{ imageUrl, linkUrl, title, subtitle }, ...]
  sortOrder Int      @default(0)
  active    Boolean  @default(true)
  position  String   @default("hero") // "hero" = top carousel, "mid" = mid-page
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // Multi-tenant
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@index([position, sortOrder])
  @@index([active])
  @@index([tenantId])
}

model PaymentMethod {
  id          String   @id @default(cuid())
  name        String   // "FPS 轉數快", "PayMe", "Alipay HK"
  type        String   @unique // "fps", "payme", "alipay"
  qrImage     String?  // URL to QR code image
  accountInfo String?  // e.g. FPS ID, phone number
  active      Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  // Multi-tenant
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@index([active, sortOrder])
  @@index([tenantId])
}

model Category {
  id        String     @id @default(cuid())
  tenantId  String
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  name      String
  slug      String
  parentId  String?
  parent    Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryTree")
  sortOrder Int        @default(0)
  imageUrl  String?
  active    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  products  Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model ProductVariant {
  id             String   @id @default(cuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  productId      String
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku            String?
  name           String
  price          Float?
  compareAtPrice Float?
  stock          Int      @default(0)
  options        Json?
  imageUrl       String?
  active         Boolean  @default(true)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([tenantId, sku])
  @@index([tenantId])
  @@index([productId])
}

model AttributeDefinition {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  name      String
  slug      String
  type      String   @default("select")
  options   Json?
  required  Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model TenantPaymentConfig {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  providerId  String   // e.g. "stripe", "fps", "payme", "bank_transfer"
  enabled     Boolean  @default(false)
  config      Json?    // provider-specific settings
  displayName String?  // 商戶自訂顯示名
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tenantId, providerId])
  @@index([tenantId])
}
