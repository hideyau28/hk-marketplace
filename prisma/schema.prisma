generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model StoreSettings {
  // singleton row
  id             String   @id @default("default")
  storeName      String? // optional so minimal payload won't crash
  tagline        String?
  returnsPolicy  String?
  shippingPolicy String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model IdempotencyKey {
  id           String   @id @default(cuid())
  key          String
  route        String
  method       String
  requestHash  String
  status       Int
  responseJson Json
  createdAt    DateTime @default(now())

  @@unique([key, route, method])
  @@index([createdAt])
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLING
  SHIPPED
  COMPLETED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum FulfillmentType {
  PICKUP
  DELIVERY
}

enum PaymentProvider {
  STRIPE
}

enum PaymentAttemptStatus {
  CREATED
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  DISPUTED
}

model Order {
  id                 String          @id @default(cuid())
  customerName       String
  phone              String
  email              String?
  items              Json
  amounts            Json
  fulfillmentType    FulfillmentType
  fulfillmentAddress Json?
  status             OrderStatus     @default(PENDING)
  note               String?

  // Payments (Stripe Checkout) - legacy fields
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  paidAt                  DateTime?

  // Fulfillment timestamps (auto-set on status change, write-once)
  fulfillingAt DateTime?
  shippedAt    DateTime?
  completedAt  DateTime?
  cancelledAt  DateTime?
  refundedAt   DateTime?
  disputedAt   DateTime?

  paymentAttempts PaymentAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
}

model PaymentAttempt {
  id       String               @id @default(cuid())
  provider PaymentProvider
  status   PaymentAttemptStatus @default(CREATED)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  amount   Int?
  currency String?

  // Stripe identifiers
  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?
  stripeChargeId          String?

  failureCode    String?
  failureMessage String?

  // Audit/debug
  lastEventId   String?
  lastEventType String?
  lastEvent     Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([provider, status])
  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
  @@index([stripeChargeId])
}

model Product {
  id         String   @id @default(cuid())
  brand      String? // optional for backward compatibility
  title      String
  price      Float
  imageUrl   String?
  category   String? // optional: categorize products for rails/hero links
  badges     Json?
  sizeSystem String? // "EU", "US", "UK", "Universal", "Multi"
  sizes      Json? // JSON array of available sizes
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([active])
  @@index([brand])
  @@index([category])
}
